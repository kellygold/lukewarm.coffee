<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Magically Integrations Catalog</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.runalloy.com/scripts/embedded.js" type="text/javascript"></script>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background-color: #f4f6f9;
        margin: 0;
      }
      .workflow-option {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  background-color: white;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
}

.workflow-option input[type="checkbox"] {
  margin-right: 10px;
  flex-shrink: 0;
}

.block-icon {
  width: 20px;
  height: 20px;
  object-fit: contain;
  margin-right: 5px;
}

.workflow-name {
  flex: 1;
}
      .header {
        background-color: #1a6db3;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: white;
        font-weight: 500;
      }
      
      .header .logo {
        font-size: 20px;
      }
      
      .main-content {
        display: flex;
        padding: 30px;
      }
      
      .sidebar {
        width: 250px;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar .section {
        margin-bottom: 20px;
      }
      
      .sidebar h3 {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
      }
      
      .sidebar ul {
        list-style: none;
        padding: 0;
      }
      
      .sidebar li {
        margin-bottom: 5px;
      }
      
      .sidebar a {
        text-decoration: none;
        color: #1a6db3;
        font-weight: 400;
      }
      
      .integration-container {
        flex: 1;
        margin-left: 30px;
      }
      
      .integration-card {
        display: flex;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      
      .integration-card img {
        width: 100px;
        height: 100px;
        object-fit: contain;
        margin-right: 20px;
      }
      
      .integration-card h3 {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
      }
      
      .integration-card p {
        margin-bottom: 10px;
        font-weight: 400;
        color: #333;
      }
      
      .integration-card button {
        background-color: #1a6db3;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        font-weight: 500;
        cursor: pointer;
      }
      .modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 50%;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}


    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">Magically</div>
    </header>

    <div class="main-content">
      <aside class="sidebar">
        <div class="section">
          <h3>Integrations</h3>
          <ul>
            <li><a href="#" class="selected">All Integrations</a></li>
            <li><a href="#">Featured</a></li>
            <li><a href="#">Popular</a></li>
            <li><a href="#">New</a></li>
          </ul>
        </div>
        <div class="section">
          <h3>Categories</h3>
          <ul>
            <li><a href="#" class="selected">All Categories</a></li>
            <li><a href="#">Email & SMS</a></li>
            <li><a href="#">Customer Service</a></li>
            <li><a href="#">Analytics</a></li>
            <li><a href="#">Automation</a></li>
          </ul>
        </div>
      </aside>

      <div class="integration-container" id="integration-options">
        <!-- Workflows Modal -->
<div id="workflowsModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Select Workflows</h3>
    <div id="workflows-container"></div>
    <button id="connect-workflows">Connect Selected Workflows</button>
  </div>
</div>

        <!-- The integration options will be added here -->
      </div>
    </div>

    <script>
      // Get the close button element
const closeModal = document.querySelector('.close');

// Add a click event listener to the close button
closeModal.addEventListener('click', () => {
  // Hide the modal
  document.getElementById('workflowsModal').style.display = 'none';
});

      // The click event handler for integration options
      let integrationsData = [];

      async function selectIntegration(integrationId) {
      const selectedIntegration = integrationsData.data.find(
    (integration) => integration.integrationId === integrationId
  );

  if (selectedIntegration.workflows.length > 1) {
    displayWorkflowsModal(selectedIntegration);
  } else {
    Alloy.setToken('<%= data.token %>');
    Alloy.install({
      integrationId: integrationId,
      callback: () => {
        console.log('Alloy Embedded Modal installed successfully.');
      },
    });
  }
}
function displayWorkflowsModal(integration) {
  const workflowsContainer = document.getElementById('workflows-container');
  workflowsContainer.innerHTML = '';

  for (const workflow of integration.workflows) {
    const label = document.createElement('label');
    label.className = 'workflow-option';

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.name = 'workflow';
    input.value = workflow.workflowId;
    input.checked = workflow.installed;
    label.appendChild(input);

    // Display block icons
    for (const block of workflow.blocks) {
      const blockIcon = document.createElement('img');
      blockIcon.className = 'block-icon';
      blockIcon.src = block.icon;
      label.appendChild(blockIcon);
    }

    const workflowNameWrapper = document.createElement('div');
    workflowNameWrapper.className = 'workflow-name';

    const text = document.createTextNode(workflow.name);
    workflowNameWrapper.appendChild(text);
    label.appendChild(workflowNameWrapper);

    workflowsContainer.appendChild(label);
  }

  // Show the modal
  document.getElementById('workflowsModal').style.display = 'block';
}


document.getElementById('connect-workflows').addEventListener('click', () => {
  const selectedWorkflows = Array.from(
    document.querySelectorAll('input[name="workflow"]:checked')
  ).map((checkbox) => checkbox.value);

  Alloy.setToken('<%= data.token %>');
  Alloy.install({
    workflowIds: selectedWorkflows,
    callback: () => {
      console.log('Selected workflows installed successfully.');
    },
    alwaysShowAuthentication: true,
    hide: false,
    title: 'Cool Alloy Workflows',
  });

  // Hide the modal
});

async function connectHeadlessly(integrationId, appName) {
        if (appName === "Shopify" || appName === "Salesforce CRM") {
            const subdomain = prompt("Please enter your shop subdomain:");
            if (subdomain) {
                try {
                    const apiKey = sessionStorage.getItem('apiKey');
                    const userId = sessionStorage.getItem('userId');
                    const response = await fetch(`https://embedded.runalloy.com/2023-01/users/${userId}/credentials/${appName.toLowerCase()}?integrationId=${integrationId}&shopSubdomain=${subdomain}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `bearer ${apiKey}`,
                            'Accept': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.data && data.data.redirectUrl) {
                        window.open(data.data.redirectUrl, '_blank');
                    } else {
                        console.error("Failed to get redirect URL");
                    }
                } catch (error) {
                    console.error('Error connecting headlessly:', error);
                }
            }
        } else {
            alert("Headless connection is not supported for this app.");
        }
    }

      // Fetch the integration data and render the options
      (async function () {
        Alloy.setToken('<%= data.token %>');
        integrationsData = await Alloy.getIntegrations();
        const integrationOptions = document.getElementById('integration-options');

        for (const integration of integrationsData.data) {
            const option = document.createElement('div');
            option.classList.add('integration-card');
            const buttonText = integration.workflows.length > 1 ? 'View Workflows' : 'Connect';
            option.innerHTML = `
                <img src="${integration.icon}" alt="${integration.app}">
                <div>
                    <h3>${integration.app}</h3>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin commodo, nisi et bibendum venenatis, sapien sapien interdum erat, id bibendum nisl libero vitae justo.</p>
                    <button onclick="selectIntegration('${integration.integrationId}')">${buttonText}</button>
                    <button onclick="connectHeadlessly('${integration.integrationId}', '${integration.app}')">Connect Headlessly</button>
                </div>`;
            integrationOptions.appendChild(option);
        }
    })();
    </script>
  </body>
</html>
